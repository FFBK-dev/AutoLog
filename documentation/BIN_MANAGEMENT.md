# Dynamic Bin Management System

## Overview

The Dynamic Bin Management System automatically discovers Avid Media Composer bins from the PROJECT_E2E volume and provides them to AI tagging workflows for selecting primary bins. This system separates the concepts of **tags** (for content categorization) and **bins** (for Avid project organization).

## Key Concepts

### Tags vs. Bins

- **Tags**: Content-based categorization (e.g., "Plantation", "Church", "River")
  - Located in: `tags/stills-tags.tab` and `tags/footage-tags.tab`
  - Multiple tags per asset (up to 4 for stills, unlimited for footage)
  - Static list manually curated

- **Bins**: Avid project organization (e.g., specific bin names from BY CATEGORY folders)
  - Located in: `tags/stills-bins.txt`, `tags/archival-footage-bins.txt`, `tags/live-footage-bins.txt`
  - ONE primary bin per asset
  - **Dynamic list** automatically generated by scanning PROJECT_E2E

### Why Separate?

Assistant editors dynamically create and remove bins in the Avid project. By scanning the actual Avid bin structure, we ensure the AI always selects from currently available bins, keeping the FileMaker database in sync with the actual Avid project structure.

## Bin Directory Structure

The system scans three directories on the PROJECT_E2E volume:

### Stills Bins
- **Source**: `/Volumes/PROJECT_E2E/E2E/5. STILLS/5b. BY CATEGORY`
- **Output**: `tags/stills-bins.txt`
- **Usage**: `jobs/stills_autotag.py`, `jobs/stills_autolog_05_generate_description.py`

### Archival Footage Bins
- **Source**: `/Volumes/PROJECT_E2E/E2E/6. ARC FOOTAGE/6b. BY CATEGORY`
- **Output**: `tags/archival-footage-bins.txt`
- **Usage**: `jobs/footage_autolog_tags_simple.py`, `jobs/ftg_autolog_B_02_gemini_analysis.py` (for AF* footage)

### Live Footage Bins
- **Source**: 
  - `/Volumes/PROJECT_E2E/E2E/7. LIVE FOOTAGE/7b. BY CATEGORY`
  - `/Volumes/PROJECT_E2E/E2E/7. LIVE FOOTAGE/7c. BY LOCATION`
- **Output**: `tags/live-footage-bins.txt` (combined from both directories)
- **Usage**: `jobs/footage_autolog_tags_simple.py`, `jobs/ftg_autolog_B_02_gemini_analysis.py` (for LF* footage)

## Bin Scanning Process

### How It Works

1. **Mount Volume**: PROJECT_E2E volume is automatically mounted on API startup
2. **Scan Directories**: Recursively finds all `.avb` files in the specified directories
3. **Extract Names**: Removes `.avb` extension to get bin names
4. **Remove Duplicates**: Ensures unique bin names
5. **Sort Alphabetically**: Orders bins for easy review
6. **Generate Files**: Writes to `tags/` folder with header comments

### Bin File Format

Generated bin files follow this format:

```
# STILLS BINS
# Generated: 2025-01-15 10:30:00
# Total bins: 45
#
Bin Name 1
Bin Name 2
Bin Name 3
...
```

### Nested Subdirectories

The scanner handles nested subdirectories automatically. For example:

```
7b. BY CATEGORY/
  ‚îú‚îÄ‚îÄ Plantations/
  ‚îÇ   ‚îú‚îÄ‚îÄ Rice.avb
  ‚îÇ   ‚îî‚îÄ‚îÄ Cotton.avb
  ‚îú‚îÄ‚îÄ Churches.avb
  ‚îî‚îÄ‚îÄ Streets/
      ‚îî‚îÄ‚îÄ Urban.avb
```

All bins (Rice, Cotton, Churches, Urban) are discovered regardless of depth.

## API Endpoints

### Trigger Bin Scan

```bash
POST /scan/bins
```

**Parameters**:
- `force_refresh` (optional): Force rescan even if files are recent

**Response**:
```json
{
  "job_id": "bin_scan_123_1737051600",
  "job_name": "bin_scan",
  "submitted": true,
  "status": "running",
  "message": "Bin scan started - scanning PROJECT_E2E for .avb files"
}
```

**Usage**:
```bash
curl -X POST http://localhost:8000/scan/bins \
  -H "x-api-key: your_api_key_here"
```

### Check Bin Status

```bash
GET /scan/bins/status
```

**Response**:
```json
{
  "status": "success",
  "timestamp": "2025-01-15T10:30:00",
  "total_bins": 150,
  "media_types": {
    "stills": {
      "exists": true,
      "bin_count": 45,
      "last_updated": "2025-01-15T08:00:00",
      "file_path": "/path/to/tags/stills-bins.txt"
    },
    "archival": {
      "exists": true,
      "bin_count": 52,
      "last_updated": "2025-01-15T08:00:00",
      "file_path": "/path/to/tags/archival-footage-bins.txt"
    },
    "live": {
      "exists": true,
      "bin_count": 53,
      "last_updated": "2025-01-15T08:00:00",
      "file_path": "/path/to/tags/live-footage-bins.txt"
    }
  }
}
```

**Usage**:
```bash
curl http://localhost:8000/scan/bins/status
```

## Workflow Integration

### How AI Selects Bins

When AI processes an asset for tagging:

1. **Load Tags**: System loads appropriate tag list (stills or footage)
2. **Load Bins**: System loads appropriate bin list based on asset type/ID
3. **AI Analysis**: AI analyzes content with both lists
4. **Separate Selection**:
   - **Tags**: AI selects multiple relevant tags (up to 4 for stills, unlimited for footage)
   - **Primary Bin**: AI selects ONE bin that best represents the asset for Avid organization
5. **Write to FileMaker**:
   - Tags written to `TAGS_List` field
   - Primary bin written to `INFO_PrimaryBin` field

### Footage ID-Based Bin Selection

For footage workflows, the system automatically selects the appropriate bin list:

- **AF*** (Archival Footage): Uses `archival-footage-bins.txt`
- **LF*** (Live Footage): Uses `live-footage-bins.txt`
- **Other**: Defaults to `live-footage-bins.txt`

This happens automatically in:
- `jobs/footage_autolog_tags_simple.py`
- `jobs/ftg_autolog_B_02_gemini_analysis.py`

## Scheduling

### Automatic Scanning

Bins are automatically scanned in two ways:

#### Option 1: API Startup (Automatic)
- **Bins are automatically scanned every time the API starts**
- Happens after PROJECT_E2E volume is successfully mounted
- Ensures bins are always fresh when API restarts
- Logs results to console and api.log
- Non-blocking - if scan fails, API continues and bins can be scanned on-demand

**Startup Log Example:**
```
üöÄ Starting FileMaker Automation API
üîß Mounting network volumes...
‚úÖ Project volume mounted successfully
üîç Scanning Avid bins from PROJECT_E2E...
  ‚úÖ stills: 88 bins
  ‚úÖ archival: 5 bins
  ‚úÖ live: 65 bins
‚úÖ Bin scan complete
```

#### Option 2: Scheduled Task (Optional)
For additional freshness between API restarts, create a daily cron job or launchd plist to scan bins:

**Cron Example** (daily at 6 AM):
```bash
0 6 * * * curl -X POST http://localhost:8000/scan/bins \
  -H "x-api-key: your_api_key_here"
```

**Launchd Example**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" 
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.filemaker.binscanner</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/curl</string>
        <string>-X</string>
        <string>POST</string>
        <string>http://localhost:8000/scan/bins</string>
        <string>-H</string>
        <string>x-api-key: your_api_key_here</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>6</integer>
        <key>Minute</key>
        <integer>0</integer>
    </dict>
</dict>
</plist>
```

### Manual Scanning

Trigger a scan anytime:

**Option 1: Command Line**
```bash
python3 utils/bin_scanner.py
```

**Option 2: API Endpoint**
```bash
curl -X POST http://localhost:8000/scan/bins
```

**Option 3: Restart API**
```bash
# Bins are automatically scanned on startup
sudo systemctl restart filemaker-api  # or your restart method
```

## Troubleshooting

### Volume Not Mounted

**Symptom**: Bin scanner reports directories not found

**Solution**:
1. Check if PROJECT_E2E is mounted: `ls /Volumes/PROJECT_E2E`
2. Manually mount: `open smb://admin:july1776@10.0.222.138/PROJECT_E2E`
3. Restart API to auto-mount on startup

### No Bins Found

**Symptom**: Bin files are empty or have 0 bins

**Solution**:
1. Verify .avb files exist in scan directories
2. Check directory paths in `utils/bin_scanner.py`
3. Verify volume is mounted with correct permissions

### Bins Not Loading in Workflows

**Symptom**: Jobs fail with "Failed to load bins from stills-bins.txt"

**Solution**:
1. Check if bin files exist: `ls tags/*.txt`
2. Run bin scanner: `python3 utils/bin_scanner.py`
3. Verify file permissions: `chmod 644 tags/*-bins.txt`

### Old Bins Appearing

**Symptom**: AI selects bins that no longer exist in Avid

**Solution**:
1. Run bin scan: `curl -X POST http://localhost:8000/scan/bins`
2. Verify scan completed: `curl http://localhost:8000/scan/bins/status`
3. Check last_updated timestamps

## File Locations

### Source Code
- **Bin Scanner**: `utils/bin_scanner.py`
- **API Endpoints**: `API.py` (lines 1954-2028)
- **Config**: `config.py` (VOLUMES dictionary)

### Generated Files
- **Stills Bins**: `tags/stills-bins.txt`
- **Archival Footage Bins**: `tags/archival-footage-bins.txt`
- **Live Footage Bins**: `tags/live-footage-bins.txt`

### Job Scripts Using Bins
- `jobs/stills_autotag.py`
- `jobs/stills_autolog_05_generate_description.py`
- `jobs/footage_autolog_tags_simple.py`
- `jobs/ftg_autolog_B_02_gemini_analysis.py`
- `jobs/ftg_autolog_B_03_create_frames.py`

## Best Practices

1. **Scan After Bin Changes**: Run bin scan whenever assistant editors add/remove bins in Avid
2. **Verify Regularly**: Check `/scan/bins/status` to ensure bins are up-to-date
3. **Monitor Logs**: Watch API logs for scan completion and any errors
4. **Backup Bin Lists**: Bin files are small text files - include in backups
5. **Test Before Production**: Test bin scanning in development before deploying to production

## FileMaker Integration

### Fields
- **TAGS_List**: Comma-separated list of tags
- **INFO_PrimaryBin**: Single bin name selected by AI

### Field Mapping
```python
FIELD_MAPPING = {
    "tags_list": "TAGS_List",
    "primary_bin": "INFO_PrimaryBin"
}
```

### Avid Panel Integration
The primary bin field can be used by the Avid panel to:
- Auto-organize clips into appropriate bins
- Suggest bin placements to editors
- Filter/search by primary bin
- Generate bin reports

## Future Enhancements

Potential improvements to the system:

1. **Bin Hierarchy**: Preserve folder structure in bin names (e.g., "Plantations > Rice")
2. **Bin Descriptions**: Extract bin comments/descriptions from Avid
3. **Change Detection**: Track which bins were added/removed since last scan
4. **Validation**: Warn if AI selects bins that no longer exist
5. **Multi-Project Support**: Scan multiple Avid projects simultaneously

## Support

For issues or questions:
1. Check troubleshooting section above
2. Review API logs: `tail -f api.log`
3. Test bin scanner directly: `python3 utils/bin_scanner.py status`
4. Verify volume access: `ls -la /Volumes/PROJECT_E2E/E2E/`

